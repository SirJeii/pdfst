<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Signature & Stamp Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Driver.js for Tour -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }

        #canvas-container {
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            margin: 0 auto;
            background-color: white;
        }
        canvas { display: block; max-width: 100%; height: auto; }

        .movable-block {
            position: absolute;
            cursor: move;
            border: 2px dashed rgba(59, 130, 246, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            user-select: none;
            touch-action: none;
            background-color: rgba(255, 255, 255, 0.4);
            transition: box-shadow 0.2s;
        }
        .movable-block:hover { border-color: #2563eb; background-color: rgba(59, 130, 246, 0.05); }
        .movable-block.active { border-color: #2563eb; box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); z-index: 50; }

        .stamp-block { border-style: solid; border-width: 3px; border-radius: 4px; font-weight: 800; text-transform: uppercase; }
        
        .delete-btn {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .movable-block:hover .delete-btn { opacity: 1; }

        .sig-image { width: 100%; height: auto; pointer-events: none; mix-blend-mode: multiply; margin-bottom: -5px; }
        .sig-text { text-align: center; pointer-events: none; white-space: nowrap; }
        .sig-name { font-weight: bold; font-size: 16px; text-decoration: underline; }
        .sig-date { font-size: 11px; color: #444; }

        .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: #2563eb;
            border: 2px solid white;
            border-radius: 50%;
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
            opacity: 0;
        }
        .movable-block:hover .resize-handle { opacity: 1; }
        
        .loading-spinner {
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .driver-popover.driverjs-theme { background-color: #1e293b; color: #ffffff; }

        .stamp-bank-item {
            cursor: pointer;
            transition: all 0.2s;
            border-width: 1px;
            font-size: 10px;
            font-weight: bold;
            text-transform: uppercase;
        }
        .stamp-bank-item:hover { transform: translateY(-1px); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        
        /* Modal Styles */
        #validation-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body class="flex flex-col bg-gray-100 h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-850 text-white border-b border-slate-700 z-30 flex-none h-14">
        <div class="w-full px-4 h-full flex items-center justify-between">
            <h1 class="text-lg font-bold flex items-center gap-2 tracking-wide">
                <i class="fas fa-file-signature text-blue-400"></i> <span>PDF Pro Signer</span>
            </h1>
            <div class="flex items-center gap-4">
                <button id="start-tour-btn" class="text-sm text-slate-300 hover:text-white flex items-center gap-1 transition-colors">
                    <i class="far fa-question-circle"></i> Help
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex flex-1 overflow-hidden relative">
        
        <!-- LEFT SIDEBAR -->
        <aside class="w-80 lg:w-96 bg-white shadow-xl z-20 flex flex-col border-r border-gray-200 h-full overflow-hidden" id="sidebar">
            <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-6">
                
                <!-- 1. Documents -->
                <div class="space-y-3" id="tour-step-1">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">1. Documents</h2>
                    <label class="block w-full cursor-pointer bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-200 rounded-lg px-4 py-3 text-sm text-blue-700 transition-colors text-center">
                        <i class="fas fa-plus-circle mr-2"></i> <span>Add PDF Files</span>
                        <input type="file" id="pdf-input" accept="application/pdf" multiple class="hidden">
                    </label>
                    <div id="file-list-container" class="hidden space-y-2">
                        <div class="flex justify-between items-center text-[10px] text-gray-500 uppercase font-bold">
                            <span id="file-count">0 files</span>
                            <button id="clear-pdfs" class="text-red-500 hover:text-red-700">Clear All</button>
                        </div>
                        <ul id="file-list" class="space-y-1 max-h-32 overflow-y-auto border border-gray-100 rounded bg-gray-50 p-1"></ul>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- 2. Signature -->
                <div class="space-y-4" id="tour-step-2">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">2. Signature</h2>
                    <div>
                        <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Image</label>
                        <label class="flex w-full cursor-pointer bg-gray-50 hover:bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-600 items-center overflow-hidden">
                            <i class="fas fa-image mr-2 text-gray-400"></i> 
                            <span id="img-name" class="truncate">Select PNG/JPG...</span>
                            <input type="file" id="img-input" accept="image/png, image/jpeg" class="hidden">
                        </label>
                    </div>
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Name</label>
                            <input type="text" id="sig-name-input" placeholder="John Doe" class="w-full border border-gray-300 rounded-md px-2 py-1.5 text-sm focus:ring-1 focus:ring-blue-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-[11px] font-bold text-gray-500 uppercase mb-1">Date</label>
                            <div class="w-full bg-gray-100 border border-gray-200 rounded-md px-2 py-1.5 text-xs text-gray-500 truncate">
                                <span id="system-date">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- 3. Custom Stamps -->
                <div class="space-y-4" id="tour-step-stamps">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider flex justify-between">
                        <span>3. Custom Stamps</span>
                        <span class="text-[10px] bg-red-100 text-red-600 px-1.5 rounded">Page Specific</span>
                    </h2>
                    <div class="space-y-3">
                        <div class="flex gap-2">
                            <input type="text" id="stamp-text-input" placeholder="e.g. PAID" class="flex-1 border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-1 focus:ring-red-500 outline-none">
                            <button id="add-stamp-btn" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded-md transition-colors" title="Add stamp to current page">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="flex items-center justify-between gap-3 bg-gray-50 p-2 rounded-md border border-gray-100">
                            <div class="flex items-center gap-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase">Color:</label>
                                <input type="color" id="stamp-color" value="#ef4444" class="w-8 h-8 rounded border-none bg-transparent cursor-pointer">
                            </div>
                            <div class="flex items-center gap-2">
                                <input type="checkbox" id="stamp-border" checked class="w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                                <label for="stamp-border" class="text-[10px] font-bold text-gray-400 uppercase cursor-pointer">Border</label>
                            </div>
                        </div>
                        
                        <!-- Stamp Preview Area -->
                        <div class="mt-4 p-2 bg-gray-50 rounded-md border border-gray-200">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-[10px] font-bold text-gray-400 uppercase block">Live Preview</label>
                                <button id="save-to-bank-btn" class="text-[9px] bg-blue-600 text-white px-2 py-0.5 rounded hover:bg-blue-700 transition-colors uppercase font-bold">Save to Bank</button>
                            </div>
                            <div class="flex justify-center py-4 bg-white rounded border border-gray-100 min-h-[60px] items-center">
                                <div id="stamp-preview" class="stamp-block px-4 py-2 text-xl pointer-events-none" style="border-color: #ef4444; color: #ef4444;">PAID</div>
                            </div>
                        </div>

                        <!-- Stamp Bank -->
                        <div id="stamp-bank-container" class="hidden space-y-2 mt-4">
                            <label class="text-[10px] font-bold text-gray-400 uppercase block">Saved Stamps (Bank)</label>
                            <div id="stamp-bank-list" class="flex flex-wrap gap-2 p-2 bg-gray-50 rounded-md border border-gray-200 min-h-[40px]">
                                <!-- Saved stamps will appear here -->
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- 4. Navigation & Validation -->
                <div id="controls-overlay" class="opacity-40 pointer-events-none space-y-4">
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-100 space-y-3">
                        <div class="flex justify-between items-center">
                            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Nav</h2>
                            <span id="current-file-display" class="text-[10px] font-mono bg-white px-2 py-1 rounded border text-gray-600">File 0/0</span>
                        </div>
                        <div class="flex items-center justify-between gap-2">
                            <button id="prev-file" class="flex-1 px-2 py-1 bg-white border border-gray-200 rounded hover:bg-gray-50 text-[11px] font-medium disabled:opacity-50">Prev File</button>
                            <button id="next-file" class="flex-1 px-2 py-1 bg-white border border-gray-200 rounded hover:bg-gray-50 text-[11px] font-medium disabled:opacity-50">Next File</button>
                        </div>
                        <div class="flex items-center justify-between bg-white rounded border border-gray-200 p-1">
                            <button id="prev-page" class="p-1 hover:bg-gray-100 rounded text-gray-400 disabled:opacity-30"><i class="fas fa-chevron-left"></i></button>
                            <span class="text-xs font-bold text-gray-700">Page <span id="curr-page">1</span> / <span id="total-pages">?</span></span>
                            <button id="next-page" class="p-1 hover:bg-gray-100 rounded text-gray-400 disabled:opacity-30"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                    
                    <div class="space-y-2">
                        <select id="position-select" class="w-full bg-white border border-gray-300 text-xs rounded-md p-2 outline-none">
                            <option value="bottom-right">Align: Bottom Right</option>
                            <option value="bottom-left">Align: Bottom Left</option>
                            <option value="top-right">Align: Top Right</option>
                            <option value="manual">Align: Manual (Drag)</option>
                        </select>
                        <div class="flex gap-2">
                            <button id="apply-all-btn" class="flex-1 text-blue-600 hover:text-blue-700 text-[10px] font-bold py-2 border border-blue-100 rounded bg-blue-50 transition-colors">
                                <i class="fas fa-clone mr-1"></i> Apply to All
                            </button>
                            <button id="verify-btn" class="flex-1 text-amber-600 hover:text-amber-700 text-[10px] font-bold py-2 border border-amber-100 rounded bg-amber-50 transition-colors">
                                <i class="fas fa-check-double mr-1"></i> Verify Signs
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-5 border-t border-gray-200 bg-gray-50">
                <button id="save-btn" class="w-full shadow-lg bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transform transition active:scale-95 disabled:opacity-50">
                    <i class="fas fa-file-download"></i> <span id="download-text">Download Signed PDF</span>
                </button>
            </div>
        </aside>

        <!-- RIGHT AREA -->
        <div class="flex-1 bg-gray-200 relative flex flex-col h-full overflow-hidden">
            <div id="workspace-scroll" class="flex-1 overflow-auto p-8 flex justify-center items-start">
                <!-- Blank State -->
                <div id="blank-state" class="flex flex-col items-center justify-center h-full text-gray-400 mt-20">
                    <i class="fas fa-file-pdf text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium">Upload a PDF to start</p>
                </div>

                <!-- Canvas Container -->
                <div id="canvas-container" class="hidden transition-transform duration-200 origin-top">
                    <canvas id="pdf-render"></canvas>
                    <!-- Signature and Stamps injected here -->
                </div>
            </div>

            <!-- Zoom Controls -->
            <div class="absolute bottom-6 right-6 flex bg-white shadow-xl rounded-full overflow-hidden border border-gray-200">
                <button id="zoom-out" class="p-3 hover:bg-gray-100 text-gray-600 border-r border-gray-100"><i class="fas fa-minus"></i></button>
                <span id="zoom-level" class="px-4 py-3 text-xs font-bold text-gray-500 bg-gray-50 flex items-center">100%</span>
                <button id="zoom-in" class="p-3 hover:bg-gray-100 text-gray-600"><i class="fas fa-plus"></i></button>
            </div>
        </div>
    </main>

    <!-- Validation Modal -->
    <div id="validation-modal" class="flex">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                <i class="fas fa-clipboard-check text-blue-500"></i> Signature Verification
            </h3>
            <div id="validation-content" class="max-h-80 overflow-y-auto mb-6 custom-scroll">
                <!-- Validation result list -->
            </div>
            <div class="flex justify-end">
                <button id="close-modal-btn" class="bg-slate-800 text-white px-5 py-2 rounded-lg font-bold text-sm">Close</button>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 z-50 opacity-0 pointer-events-none flex items-center gap-3">
        <i class="fas fa-info-circle text-blue-400"></i> <span id="toast-msg">Message</span>
    </div>

    <script>
        // --- State Management ---
        const state = {
            files: [], // { name, buffer, pageCount }
            currentFileIndex: 0,
            previewDoc: null, 
            imgBytes: null, 
            imgType: null,
            pageNum: 1,
            scale: 0.8, 
            totalPages: 0,
            name: "",
            date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
            sigBlockEl: null,
            customPositions: {}, // Global signature positions
            stamps: {}, // Key: "fileIdx-pageIdx", Value: [ { text, color, hasBorder, xPct, yPct, wPct } ]
            stampBank: [], // Array of saved stamp objects: { text, color, hasBorder }
            batchTemplate: null
        };

        const els = {
            pdfInput: document.getElementById('pdf-input'),
            imgInput: document.getElementById('img-input'),
            fileCount: document.getElementById('file-count'),
            clearPdfsBtn: document.getElementById('clear-pdfs'),
            fileListContainer: document.getElementById('file-list-container'),
            fileList: document.getElementById('file-list'),
            imgName: document.getElementById('img-name'),
            nameInput: document.getElementById('sig-name-input'),
            dateDisplay: document.getElementById('system-date'),
            controlsOverlay: document.getElementById('controls-overlay'),
            canvas: document.getElementById('pdf-render'),
            container: document.getElementById('canvas-container'),
            blankState: document.getElementById('blank-state'),
            prevBtn: document.getElementById('prev-page'),
            nextBtn: document.getElementById('next-page'),
            prevFileBtn: document.getElementById('prev-file'),
            nextFileBtn: document.getElementById('next-file'),
            currentFileDisplay: document.getElementById('current-file-display'),
            currPageSpan: document.getElementById('curr-page'),
            totalPageSpan: document.getElementById('total-pages'),
            saveBtn: document.getElementById('save-btn'),
            downloadText: document.getElementById('download-text'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            positionSelect: document.getElementById('position-select'),
            applyAllBtn: document.getElementById('apply-all-btn'),
            verifyBtn: document.getElementById('verify-btn'),
            zoomIn: document.getElementById('zoom-in'),
            zoomOut: document.getElementById('zoom-out'),
            zoomLevel: document.getElementById('zoom-level'),
            tourBtn: document.getElementById('start-tour-btn'),
            stampInput: document.getElementById('stamp-text-input'),
            stampColor: document.getElementById('stamp-color'),
            stampBorder: document.getElementById('stamp-border'),
            stampPreview: document.getElementById('stamp-preview'),
            addStampBtn: document.getElementById('add-stamp-btn'),
            saveToBankBtn: document.getElementById('save-to-bank-btn'),
            stampBankList: document.getElementById('stamp-bank-list'),
            stampBankContainer: document.getElementById('stamp-bank-container'),
            validationModal: document.getElementById('validation-modal'),
            validationContent: document.getElementById('validation-content'),
            closeModalBtn: document.getElementById('close-modal-btn')
        };

        const ctx = els.canvas.getContext('2d');
        els.dateDisplay.textContent = state.date;
        els.saveBtn.disabled = true;

        // --- Core Events ---

        els.pdfInput.addEventListener('change', async (e) => {
            const rawFiles = Array.from(e.target.files);
            if (rawFiles.length === 0) return;
            
            const newFiles = await Promise.all(rawFiles.map(async f => {
                const buffer = await f.arrayBuffer();
                // We briefly load the doc just to get the total page count for later verification
                const tempDoc = await pdfjsLib.getDocument(new Uint8Array(buffer.slice(0))).promise;
                const pageCount = tempDoc.numPages;
                return { name: f.name, buffer, pageCount };
            }));

            state.files = [...state.files, ...newFiles];
            updateFileUI();
            if (state.files.length === newFiles.length) await loadFile(0);
            checkReady();
            els.pdfInput.value = '';
        });

        els.clearPdfsBtn.addEventListener('click', () => {
            state.files = []; state.customPositions = {}; state.stamps = {}; state.previewDoc = null;
            els.controlsOverlay.classList.add('opacity-40', 'pointer-events-none');
            els.blankState.classList.remove('hidden'); els.container.classList.add('hidden');
            els.saveBtn.disabled = true; updateFileUI();
        });

        els.imgInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            els.imgName.textContent = file.name;
            state.imgType = file.type;
            const reader = new FileReader();
            reader.onload = (ev) => {
                state.imgBytes = ev.target.result;
                renderSignatureBlock();
                checkReady();
                showToast("Signature Loaded");
            };
            reader.readAsDataURL(file);
        });

        els.nameInput.addEventListener('input', (e) => {
            state.name = e.target.value;
            renderSignatureBlock();
        });

        // LIVE STAMP PREVIEW LOGIC
        const updateStampPreview = () => {
            const text = els.stampInput.value.trim() || "PAID";
            const color = els.stampColor.value;
            const hasBorder = els.stampBorder.checked;
            
            els.stampPreview.textContent = text;
            els.stampPreview.style.color = color;
            els.stampPreview.style.borderColor = color;
            els.stampPreview.style.borderStyle = hasBorder ? 'solid' : 'none';
        };

        els.stampInput.addEventListener('input', updateStampPreview);
        els.stampColor.addEventListener('input', updateStampPreview);
        els.stampBorder.addEventListener('change', updateStampPreview);

        els.addStampBtn.addEventListener('click', () => {
            const text = els.stampInput.value.trim();
            if (!text) return;
            addStamp({
                text: text,
                color: els.stampColor.value,
                hasBorder: els.stampBorder.checked
            });
            els.stampInput.value = '';
            updateStampPreview();
        });

        els.saveToBankBtn.addEventListener('click', () => {
            const text = els.stampInput.value.trim() || "PAID";
            const config = {
                text: text,
                color: els.stampColor.value,
                hasBorder: els.stampBorder.checked
            };
            
            // Avoid duplicates
            const isDuplicate = state.stampBank.some(s => s.text === config.text && s.color === config.color && s.hasBorder === config.hasBorder);
            if (isDuplicate) {
                showToast("Stamp already in bank");
                return;
            }

            state.stampBank.push(config);
            renderStampBank();
            showToast("Stamp added to bank!");
        });

        function renderStampBank() {
            els.stampBankList.innerHTML = '';
            if (state.stampBank.length === 0) {
                els.stampBankContainer.classList.add('hidden');
                return;
            }
            
            els.stampBankContainer.classList.remove('hidden');
            state.stampBank.forEach((item, index) => {
                const btn = document.createElement('div');
                btn.className = 'stamp-bank-item px-2 py-1 rounded bg-white relative group';
                btn.style.borderColor = item.color;
                btn.style.color = item.color;
                btn.style.borderStyle = item.hasBorder ? 'solid' : 'dashed';
                btn.textContent = item.text;
                
                // Add to page on click
                btn.onclick = () => addStamp(item);

                // Delete button on hover
                const del = document.createElement('div');
                del.className = 'absolute -top-1 -right-1 bg-red-500 text-white w-3 h-3 flex items-center justify-center rounded-full opacity-0 group-hover:opacity-100 transition-opacity text-[8px]';
                del.innerHTML = '&times;';
                del.onclick = (e) => {
                    e.stopPropagation();
                    state.stampBank.splice(index, 1);
                    renderStampBank();
                };
                
                btn.appendChild(del);
                els.stampBankList.appendChild(btn);
            });
        }

        els.prevBtn.addEventListener('click', () => { if (state.pageNum > 1) { state.pageNum--; renderPage(); } });
        els.nextBtn.addEventListener('click', () => { if (state.pageNum < state.totalPages) { state.pageNum++; renderPage(); } });
        els.prevFileBtn.addEventListener('click', () => { if (state.currentFileIndex > 0) loadFile(state.currentFileIndex - 1); });
        els.nextFileBtn.addEventListener('click', () => { if (state.currentFileIndex < state.files.length - 1) loadFile(state.currentFileIndex + 1); });
        
        els.zoomIn.addEventListener('click', () => { if(state.scale < 2.5) { state.scale += 0.15; renderPage(); updateZoom(); } });
        els.zoomOut.addEventListener('click', () => { if(state.scale > 0.3) { state.scale -= 0.15; renderPage(); updateZoom(); } });

        els.positionSelect.addEventListener('change', (e) => {
            if (state.sigBlockEl && e.target.value !== 'manual') {
                applyPositionPreset(state.sigBlockEl, e.target.value);
                saveSigPos();
            }
        });

        els.applyAllBtn.addEventListener('click', () => {
            if (!state.sigBlockEl) return;
            saveSigPos();
            const key = `${state.currentFileIndex}-${state.pageNum}`;
            state.batchTemplate = { ...state.customPositions[key] };
            showToast("Signature position applied to all pages!");
        });

        els.verifyBtn.addEventListener('click', () => {
            const report = [];
            let allSigned = true;

            state.files.forEach((file, fIdx) => {
                const missingPages = [];
                for (let pNum = 1; pNum <= file.pageCount; pNum++) {
                    const key = `${fIdx}-${pNum}`;
                    // A page is "signed" if it has an individual position or a global batch position
                    const hasSign = state.customPositions[key] || state.batchTemplate;
                    if (!hasSign) {
                        missingPages.push(pNum);
                        allSigned = false;
                    }
                }
                if (missingPages.length > 0) {
                    report.push({ name: file.name, pages: missingPages });
                }
            });

            renderValidationReport(report, allSigned);
        });

        function renderValidationReport(report, allSigned) {
            els.validationContent.innerHTML = '';
            
            if (allSigned) {
                els.validationContent.innerHTML = `
                    <div class="text-center py-6">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-3"></i>
                        <p class="text-gray-700 font-medium">All documents are signed!</p>
                        <p class="text-gray-400 text-xs mt-1">Every page in every file has a signature position assigned.</p>
                    </div>
                `;
            } else {
                const list = document.createElement('div');
                list.className = 'space-y-4';
                
                const warning = document.createElement('p');
                warning.className = 'text-amber-600 text-xs font-bold uppercase mb-2';
                warning.textContent = 'Unsigned Pages Detected:';
                list.appendChild(warning);

                report.forEach(file => {
                    const item = document.createElement('div');
                    item.className = 'p-3 rounded-lg bg-gray-50 border border-gray-100';
                    item.innerHTML = `
                        <p class="text-[11px] font-bold text-gray-700 mb-1 truncate"><i class="fas fa-file-pdf text-red-400 mr-2"></i>${file.name}</p>
                        <div class="flex flex-wrap gap-1">
                            ${file.pages.map(p => `<span class="bg-white border border-gray-200 px-2 py-0.5 rounded text-[10px] text-gray-600">Pg ${p}</span>`).join('')}
                        </div>
                    `;
                    list.appendChild(item);
                });
                els.validationContent.appendChild(list);
            }

            els.validationModal.style.display = 'flex';
        }

        els.closeModalBtn.addEventListener('click', () => {
            els.validationModal.style.display = 'none';
        });

        els.saveBtn.addEventListener('click', generateAll);

        // --- Logic Functions ---

        async function loadFile(idx) {
            state.currentFileIndex = idx;
            const fileData = state.files[idx];
            state.previewDoc = await pdfjsLib.getDocument(new Uint8Array(fileData.buffer.slice(0))).promise;
            state.totalPages = state.previewDoc.numPages;
            state.pageNum = 1;
            els.totalPageSpan.textContent = state.totalPages;
            els.blankState.classList.add('hidden');
            els.container.classList.remove('hidden');
            els.controlsOverlay.classList.remove('opacity-40', 'pointer-events-none');
            updateNav();
            await renderPage();
        }

        async function renderPage() {
            if (!state.previewDoc) return;
            els.currPageSpan.textContent = state.pageNum;
            els.prevBtn.disabled = state.pageNum <= 1;
            els.nextBtn.disabled = state.pageNum >= state.totalPages;

            const page = await state.previewDoc.getPage(state.pageNum);
            const viewport = page.getViewport({ scale: state.scale });

            els.canvas.height = viewport.height;
            els.canvas.width = viewport.width;
            els.container.style.width = `${viewport.width}px`;
            els.container.style.height = `${viewport.height}px`;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            if (state.sigBlockEl) {
                state.sigBlockEl.style.display = 'flex';
                placeSigOnPage();
            }
            renderStampsForPage();
        }

        function renderSignatureBlock() {
            if (!state.imgBytes) return;
            if (!state.sigBlockEl) {
                const block = document.createElement('div');
                block.className = 'movable-block sig-block';
                block.innerHTML = `<img class="sig-image"><p class="sig-text sig-name"></p><p class="sig-text sig-date"></p><div class="resize-handle"></div>`;
                els.container.appendChild(block);
                state.sigBlockEl = block;
                initDragAndResize(block, null, (el) => {
                    els.positionSelect.value = 'manual';
                    saveSigPos();
                });
            }
            state.sigBlockEl.querySelector('img').src = state.imgBytes;
            state.sigBlockEl.querySelector('.sig-name').textContent = state.name || "Signatory Name";
            state.sigBlockEl.querySelector('.sig-date').textContent = state.date;
            if (!state.sigBlockEl.style.width) state.sigBlockEl.style.width = '180px';
            setTimeout(placeSigOnPage, 50);
        }

        function addStamp(config) {
            const key = `${state.currentFileIndex}-${state.pageNum}`;
            if (!state.stamps[key]) state.stamps[key] = [];
            
            const stamp = { 
                id: Date.now(),
                text: config.text, 
                color: config.color,
                hasBorder: config.hasBorder,
                leftPct: 0.1, 
                topPct: 0.1, 
                widthPct: 0.2
            };
            state.stamps[key].push(stamp);
            renderStampsForPage();
        }

        function renderStampsForPage() {
            document.querySelectorAll('.stamp-block:not(#stamp-preview)').forEach(el => el.remove());
            
            const key = `${state.currentFileIndex}-${state.pageNum}`;
            const pageStamps = state.stamps[key] || [];
            
            pageStamps.forEach(stamp => {
                const block = document.createElement('div');
                block.className = 'movable-block stamp-block';
                block.style.width = `${stamp.widthPct * els.container.offsetWidth}px`;
                block.style.left = `${stamp.leftPct * els.container.offsetWidth}px`;
                block.style.top = `${stamp.topPct * els.container.offsetHeight}px`;
                block.style.borderColor = stamp.color;
                block.style.color = stamp.color;
                block.style.borderStyle = stamp.hasBorder ? 'solid' : 'none';
                
                block.innerHTML = `<span>${stamp.text}</span><div class="delete-btn"><i class="fas fa-times"></i></div><div class="resize-handle"></div>`;
                
                els.container.appendChild(block);
                
                block.querySelector('.delete-btn').onclick = (e) => {
                    e.stopPropagation();
                    state.stamps[key] = state.stamps[key].filter(s => s.id !== stamp.id);
                    block.remove();
                };

                initDragAndResize(block, null, () => {
                    stamp.leftPct = parseInt(block.style.left) / els.container.offsetWidth;
                    stamp.topPct = parseInt(block.style.top) / els.container.offsetHeight;
                    stamp.widthPct = block.offsetWidth / els.container.offsetWidth;
                });
            });
        }

        function placeSigOnPage() {
            if (!state.sigBlockEl) return;
            const key = `${state.currentFileIndex}-${state.pageNum}`;
            if (state.customPositions[key]) {
                applyPositionPct(state.sigBlockEl, state.customPositions[key]);
                els.positionSelect.value = 'manual';
            } else if (state.batchTemplate) {
                applyPositionPct(state.sigBlockEl, state.batchTemplate);
                els.positionSelect.value = 'manual';
            } else {
                applyPositionPreset(state.sigBlockEl, 'bottom-right');
                els.positionSelect.value = 'bottom-right';
            }
        }

        function saveSigPos() {
            const key = `${state.currentFileIndex}-${state.pageNum}`;
            state.customPositions[key] = {
                leftPct: parseInt(state.sigBlockEl.style.left) / els.container.offsetWidth,
                topPct: parseInt(state.sigBlockEl.style.top) / els.container.offsetHeight,
                widthPct: state.sigBlockEl.offsetWidth / els.container.offsetWidth
            };
        }

        function applyPositionPreset(el, mode) {
            const pad = 20;
            let l = 0, t = 0;
            if (mode === 'bottom-right') { l = els.container.offsetWidth - el.offsetWidth - pad; t = els.container.offsetHeight - el.offsetHeight - pad; }
            if (mode === 'bottom-left') { l = pad; t = els.container.offsetHeight - el.offsetHeight - pad; }
            if (mode === 'top-right') { l = els.container.offsetWidth - el.offsetWidth - pad; t = pad; }
            el.style.left = `${l}px`; el.style.top = `${t}px`;
        }

        function applyPositionPct(el, pos) {
            el.style.left = `${pos.leftPct * els.container.offsetWidth}px`;
            el.style.top = `${pos.topPct * els.container.offsetHeight}px`;
            el.style.width = `${pos.widthPct * els.container.offsetWidth}px`;
        }

        function initDragAndResize(el, _handle, onFinish) {
            let dragging = false, resizing = false, startX, startY, startL, startT, startW;
            const handle = el.querySelector('.resize-handle');

            el.addEventListener('mousedown', (e) => {
                if (e.target === handle || e.target.closest('.delete-btn')) return;
                dragging = true; startX = e.clientX; startY = e.clientY;
                startL = parseInt(el.style.left); startT = parseInt(el.style.top);
                el.classList.add('active'); e.preventDefault();
            });

            handle.addEventListener('mousedown', (e) => {
                resizing = true; startX = e.clientX; startW = el.offsetWidth;
                e.stopPropagation(); e.preventDefault();
            });

            window.addEventListener('mousemove', (e) => {
                if (dragging) {
                    let nl = startL + (e.clientX - startX), nt = startT + (e.clientY - startY);
                    nl = Math.max(0, Math.min(nl, els.container.offsetWidth - el.offsetWidth));
                    nt = Math.max(0, Math.min(nt, els.container.offsetHeight - el.offsetHeight));
                    el.style.left = `${nl}px`; el.style.top = `${nt}px`;
                } else if (resizing) {
                    el.style.width = `${Math.max(60, startW + (e.clientX - startX))}px`;
                }
            });

            window.addEventListener('mouseup', () => {
                if (dragging || resizing) { el.classList.remove('active'); if(onFinish) onFinish(el); }
                dragging = resizing = false;
            });
        }

        // --- Generation ---

        async function generateAll() {
            els.downloadText.innerHTML = '<div class="loading-spinner"></div> Processing...';
            els.saveBtn.disabled = true;
            try {
                const zip = new JSZip();
                const processed = [];
                for (let i = 0; i < state.files.length; i++) {
                    const bytes = await processPDF(state.files[i].buffer, i);
                    processed.push({ name: state.files[i].name, data: bytes });
                }
                if (processed.length === 1) download(processed[0].data, `Signed_${processed[0].name}`, "application/pdf");
                else {
                    processed.forEach(f => zip.file(`Signed_${f.name}`, f.data));
                    const content = await zip.generateAsync({type: "blob"});
                    download(content, "Signed_Batch.zip", "application/zip");
                }
                showToast("Documents generated successfully!");
            } catch (e) { console.error(e); showToast("Error: " + e.message); }
            finally { els.downloadText.textContent = state.files.length > 1 ? `Download ${state.files.length} Files (ZIP)` : "Download Signed PDF"; els.saveBtn.disabled = false; }
        }

        const hexToRgb = (hex) => {
            const r = parseInt(hex.slice(1, 3), 16) / 255;
            const g = parseInt(hex.slice(3, 5), 16) / 255;
            const b = parseInt(hex.slice(5, 7), 16) / 255;
            return { r, g, b };
        };

        async function processPDF(buffer, fIdx) {
            const { PDFDocument, StandardFonts, rgb } = PDFLib;
            const pdfDoc = await PDFDocument.load(buffer.slice(0));
            const fontBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);
            const fontReg = await pdfDoc.embedFont(StandardFonts.Helvetica);

            const imgRes = await fetch(state.imgBytes);
            const imgBuf = await imgRes.arrayBuffer();
            const embeddedImg = state.imgType === 'image/jpeg' ? await pdfDoc.embedJpg(imgBuf) : await pdfDoc.embedPng(imgBuf);

            const pages = pdfDoc.getPages();
            for (let i = 0; i < pages.length; i++) {
                const p = pages[i];
                const { width: pW, height: pH } = p.getSize();
                const key = `${fIdx}-${i + 1}`;

                // 1. Render Signature
                let sigPos = state.customPositions[key] || state.batchTemplate || null;
                
                // Only render signature if a position is explicitly set (manual or batch)
                if (sigPos) {
                    const drawW = sigPos.widthPct * pW;
                    const drawX = sigPos.leftPct * pW;
                    const drawYTop = pH - (sigPos.topPct * pH);

                    const imgAspect = state.sigBlockEl.querySelector('img').naturalHeight / state.sigBlockEl.querySelector('img').naturalWidth;
                    const drawH = drawW * imgAspect;
                    const imgY = drawYTop - drawH;

                    p.drawImage(embeddedImg, { x: drawX, y: imgY, width: drawW, height: drawH });

                    if (state.name) {
                        const nameSize = 12;
                        const textW = fontBold.widthOfTextAtSize(state.name, nameSize);
                        p.drawText(state.name, { x: drawX + (drawW - textW)/2, y: imgY - 14, size: nameSize, font: fontBold });
                        p.drawText(state.date, { x: drawX + (drawW - fontReg.widthOfTextAtSize(state.date, 9))/2, y: imgY - 26, size: 9, font: fontReg, color: rgb(0.3, 0.3, 0.3) });
                    }
                }

                // 2. Render Stamps
                const pageStamps = state.stamps[key] || [];
                pageStamps.forEach(s => {
                    const sW = s.widthPct * pW;
                    const sX = s.leftPct * pW;
                    const sY = pH - (s.topPct * pH) - 30;
                    const sSize = Math.max(12, sW / 6);
                    const tw = fontBold.widthOfTextAtSize(s.text, sSize);
                    const drawColor = hexToRgb(s.color || '#ef4444');
                    const libColor = rgb(drawColor.r, drawColor.g, drawColor.b);
                    
                    if (s.hasBorder) {
                        p.drawRectangle({
                            x: sX, y: sY - 5,
                            width: Math.max(sW, tw + 20), height: sSize + 15,
                            borderColor: libColor, borderWidth: 2,
                            color: rgb(1, 0.98, 0.98)
                        });
                    }
                    p.drawText(s.text, { x: sX + 10, y: sY + 2, size: sSize, font: fontBold, color: libColor });
                });
            }
            return await pdfDoc.save();
        }

        // --- UI Helpers ---

        function updateFileUI() {
            els.fileList.innerHTML = '';
            state.files.forEach((f, i) => {
                const li = document.createElement('li');
                li.className = `text-[11px] px-2 py-1.5 rounded flex items-center gap-2 truncate cursor-pointer ${i === state.currentFileIndex ? 'bg-blue-50 text-blue-700 font-bold' : 'hover:bg-gray-100'}`;
                li.innerHTML = `<i class="fas fa-file-pdf"></i> <span class="truncate">${f.name}</span>`;
                li.onclick = () => loadFile(i);
                els.fileList.appendChild(li);
            });
            els.fileCount.textContent = `${state.files.length} files`;
            els.fileListContainer.classList.toggle('hidden', state.files.length === 0);
            els.downloadText.textContent = state.files.length > 1 ? `Download ${state.files.length} Files (ZIP)` : "Download Signed PDF";
        }

        function updateNav() {
            els.currentFileDisplay.textContent = `File ${state.currentFileIndex + 1}/${state.files.length}`;
            els.prevFileBtn.disabled = state.currentFileIndex === 0;
            els.nextFileBtn.disabled = state.currentFileIndex === state.files.length - 1;
            updateFileUI();
        }

        function updateZoom() { els.zoomLevel.textContent = Math.round(state.scale * 100) + '%'; }
        
        function checkReady() { if (state.files.length > 0 && state.imgBytes) els.saveBtn.disabled = false; }

        function download(data, filename, type) {
            const blob = new Blob([data], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); a.href = url; a.download = filename; a.click();
            URL.revokeObjectURL(url);
        }

        function showToast(msg) {
            els.toastMsg.textContent = msg; els.toast.classList.remove('opacity-0');
            setTimeout(() => els.toast.classList.add('opacity-0'), 3000);
        }

        els.tourBtn.addEventListener('click', () => {
            const driver = window.driver.js.driver;
            driver({
                showProgress: true,
                popoverClass: 'driverjs-theme',
                steps: [
                    { element: '#tour-step-1', popover: { title: '1. Documents', description: 'Upload one or multiple PDF files to be signed.' } },
                    { element: '#tour-step-2', popover: { title: '2. Signature', description: 'Upload your signature image and set your name.' } },
                    { element: '#tour-step-stamps', popover: { title: '3. Stamps & Bank', description: 'Create stamps and save them to your Bank to reuse them instantly across any page.' } },
                    { element: '#verify-btn', popover: { title: '4. Verification', description: 'Check all files and pages to see if you missed any signatures before downloading.' } },
                    { element: '#save-btn', popover: { title: '5. Download', description: 'Process everything in your browser and download the results.' } }
                ]
            }).drive();
        });

    </script>
</body>
</html>
