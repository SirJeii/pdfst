<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Signature Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <!-- Driver.js for Tour -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.js.iife.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.0.1/dist/driver.css"/>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        slate: { 850: '#1e293b' }
                    }
                }
            }
        }
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; }
        
        /* Custom Scrollbar for sidebar */
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #a8a8a8; }

        #canvas-container {
            position: relative;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            margin: 0 auto;
            background-color: white;
        }
        canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }
        .signature-block {
            position: absolute;
            cursor: move;
            border: 2px dashed rgba(59, 130, 246, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
            user-select: none;
            touch-action: none;
            transition: background-color 0.2s, border-color 0.2s;
            background-color: rgba(255, 255, 255, 0.1);
        }
        .signature-block:hover {
            border-color: #2563eb;
            background-color: rgba(59, 130, 246, 0.1);
        }
        .signature-block.active {
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .sig-image {
            width: 100%;
            height: auto;
            pointer-events: none;
            margin-bottom: -10px; 
            z-index: 20; 
            position: relative;
            mix-blend-mode: multiply;
        }
        .sig-text {
            text-align: center;
            font-family: Helvetica, Arial, sans-serif;
            line-height: 1.2;
            pointer-events: none;
            white-space: nowrap;
        }
        .sig-name {
            font-weight: bold;
            font-size: 16px;
            margin-top: 0px; 
            text-decoration: underline;
            z-index: 10;
            position: relative;
            padding-top: 5px; 
        }
        .sig-date {
            font-size: 12px;
            margin-top: 2px;
            color: #333;
            z-index: 10;
        }
        .resize-handle {
            position: absolute;
            width: 14px;
            height: 14px;
            background-color: #2563eb;
            border: 2px solid white;
            border-radius: 50%;
            bottom: -7px;
            right: -7px;
            cursor: nwse-resize;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 30;
        }
        .signature-block:hover .resize-handle { opacity: 1; }
        
        .loading-spinner {
            border: 3px solid rgba(255,255,255,0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Driver.js Customization */
        .driver-popover.driverjs-theme {
            background-color: #1e293b;
            color: #ffffff;
        }
        .driver-popover.driverjs-theme .driver-popover-title {
            font-size: 16px;
            font-weight: bold;
        }
        .driver-popover.driverjs-theme .driver-popover-description {
            font-size: 14px;
            color: #cbd5e1;
        }
        .driver-popover.driverjs-theme button {
            background-color: #3b82f6;
            color: white;
            text-shadow: none;
            border: none;
        }
        .driver-popover.driverjs-theme button:hover {
            background-color: #2563eb;
        }
    </style>
</head>
<body class="flex flex-col bg-gray-50 h-screen overflow-hidden">

    <!-- Header -->
    <header class="bg-slate-850 text-white border-b border-slate-700 z-30 flex-none h-14">
        <div class="w-full px-4 h-full flex items-center justify-between">
            <h1 class="text-lg font-bold flex items-center gap-2 tracking-wide">
                <i class="fas fa-file-signature text-blue-400"></i> <span>PDF Signer</span>
            </h1>
            <div class="flex items-center gap-4">
                <button id="start-tour-btn" class="text-sm text-slate-300 hover:text-white flex items-center gap-1 transition-colors">
                    <i class="far fa-question-circle"></i> Help
                </button>
                <div class="text-xs text-slate-500 hidden sm:block">Secure Client-Side Processing</div>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="flex flex-1 overflow-hidden relative">
        
        <!-- LEFT SIDEBAR: Controls -->
        <aside class="w-full md:w-80 lg:w-96 bg-white shadow-xl z-20 flex flex-col border-r border-gray-200 h-full transform transition-transform duration-300 absolute md:relative" id="sidebar">
            
            <div class="flex-1 overflow-y-auto custom-scroll p-5 space-y-6">
                
                <!-- Section 1: Files -->
                <div class="space-y-3" id="tour-step-1">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">1. Documents</h2>
                    
                    <div class="space-y-2">
                        <label class="block w-full cursor-pointer bg-blue-50 hover:bg-blue-100 border border-blue-200 rounded-lg px-4 py-3 text-sm text-blue-700 transition-colors flex items-center justify-center border-dashed border-2">
                            <i class="fas fa-plus-circle mr-2"></i> 
                            <span id="pdf-name">Add PDFs</span>
                            <input type="file" id="pdf-input" accept="application/pdf" multiple class="hidden">
                        </label>
                        
                        <!-- File List -->
                        <div id="file-list-container" class="hidden">
                            <div class="flex justify-between items-center text-xs text-gray-500 mb-1">
                                <span id="file-count">0 files</span>
                                <button id="clear-pdfs" class="text-red-500 hover:text-red-700">Clear All</button>
                            </div>
                            <ul id="file-list" class="space-y-1 max-h-32 overflow-y-auto border border-gray-100 rounded bg-gray-50 p-1"></ul>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Section 2: Signature -->
                <div class="space-y-4" id="tour-step-2">
                    <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">2. Signature Info</h2>
                    
                    <!-- Image Input -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Signature Image</label>
                        <label class="flex w-full cursor-pointer bg-gray-50 hover:bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-600 transition-colors items-center overflow-hidden">
                            <i class="fas fa-image mr-2 text-gray-400"></i> 
                            <span id="img-name" class="truncate">Select PNG/JPG...</span>
                            <input type="file" id="img-input" accept="image/png, image/jpeg" class="hidden">
                        </label>
                    </div>

                    <!-- Text Inputs -->
                    <div class="grid grid-cols-1 gap-3">
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Signatory Name</label>
                            <input type="text" id="sig-name-input" placeholder="e.g. John Doe" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none" disabled>
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-gray-500 mb-1">Date</label>
                            <div class="w-full bg-gray-100 border border-gray-200 rounded-md px-3 py-2 text-sm text-gray-500 cursor-not-allowed">
                                <span id="system-date">...</span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-100">

                <!-- Section 3: Navigation & Position (Only visible when active) -->
                <div id="controls-overlay" class="opacity-50 pointer-events-none transition-opacity duration-200 space-y-6">
                    
                    <!-- Navigator -->
                    <div class="bg-slate-50 p-4 rounded-lg border border-slate-100 space-y-3" id="tour-step-4">
                        <div class="flex justify-between items-center mb-2">
                            <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Navigation</h2>
                            <span id="current-file-display" class="text-xs font-mono bg-white px-2 py-1 rounded border text-gray-600">File 0/0</span>
                        </div>

                        <!-- File Nav -->
                        <div class="flex items-center justify-between gap-2">
                            <button id="prev-file" class="flex-1 px-2 py-1.5 bg-white border border-gray-200 rounded hover:bg-gray-50 text-gray-600 text-xs font-medium transition-colors disabled:opacity-50">
                                <i class="fas fa-chevron-left mr-1"></i> Prev File
                            </button>
                            <button id="next-file" class="flex-1 px-2 py-1.5 bg-white border border-gray-200 rounded hover:bg-gray-50 text-gray-600 text-xs font-medium transition-colors disabled:opacity-50">
                                Next File <i class="fas fa-chevron-right ml-1"></i>
                            </button>
                        </div>
                        
                        <!-- Page Nav -->
                        <div class="flex items-center justify-between bg-white rounded border border-gray-200 p-1">
                            <button id="prev-page" class="p-2 hover:bg-gray-100 rounded text-gray-600 disabled:opacity-30 transition-all w-10">
                                <i class="fas fa-caret-left text-lg"></i>
                            </button>
                            <span class="text-xs font-semibold text-gray-700">
                                Page <span id="curr-page">1</span> / <span id="total-pages">--</span>
                            </span>
                            <button id="next-page" class="p-2 hover:bg-gray-100 rounded text-gray-600 disabled:opacity-30 transition-all w-10">
                                <i class="fas fa-caret-right text-lg"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Positioning -->
                    <div class="space-y-3" id="tour-step-5">
                        <h2 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Positioning</h2>
                        
                        <div class="space-y-2">
                            <select id="position-select" class="w-full bg-white border border-gray-300 text-gray-700 text-sm rounded-md focus:ring-blue-500 focus:border-blue-500 block p-2.5 outline-none">
                                <option value="bottom-right">Bottom Right (Default)</option>
                                <option value="bottom-left">Bottom Left</option>
                                <option value="bottom-center">Bottom Center</option>
                                <option value="top-right">Top Right</option>
                                <option value="manual" disabled>Manual (Drag on canvas)</option>
                            </select>
                            
                            <button id="apply-all-btn" class="w-full flex items-center justify-center gap-2 bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs font-semibold py-2 px-4 rounded border border-blue-200 transition-colors" title="Copy current position to ALL pages in ALL files">
                                <i class="fas fa-clone"></i> Apply Position to All Pages
                            </button>
                        </div>
                    </div>

                </div>
            </div>

            <!-- Footer Action -->
            <div class="p-5 border-t border-gray-200 bg-gray-50 z-20">
                <button id="save-btn" class="w-full shadow-lg bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center gap-2 transform transition active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-file-download"></i> <span id="download-text">Download Signed PDF</span>
                </button>
            </div>
        </aside>

        <!-- RIGHT AREA: Canvas -->
        <div class="flex-1 bg-gray-200/50 relative flex flex-col h-full overflow-hidden">
            
            <!-- Toolbar for Mobile Toggle (Hidden on large screens) -->
            <div class="md:hidden bg-white border-b border-gray-200 p-2 flex justify-between items-center px-4">
                <span class="text-sm font-bold text-gray-600">Preview</span>
                <button id="toggle-sidebar" class="text-blue-600 font-medium text-sm">
                    <i class="fas fa-sliders-h mr-1"></i> Settings
                </button>
            </div>

            <!-- Scrollable Workspace -->
            <div id="workspace-scroll" class="flex-1 overflow-auto p-4 md:p-8 flex justify-center items-start">
                
                <!-- Blank State -->
                <div id="blank-state" class="flex flex-col items-center justify-center h-full text-gray-400 mt-20">
                    <i class="fas fa-file-pdf text-6xl mb-4 text-gray-300"></i>
                    <p class="text-lg font-medium">No Document Loaded</p>
                    <p class="text-sm">Upload a PDF in the sidebar to begin.</p>
                </div>

                <!-- Canvas Container -->
                <div id="canvas-container" class="hidden transition-transform duration-200 origin-top">
                    <canvas id="pdf-render"></canvas>
                    <!-- Signature block injected here -->
                </div>
            </div>

            <!-- Zoom Controls (Floating) -->
            <div class="absolute bottom-6 right-6 flex gap-2">
                <div class="bg-white shadow-md rounded-lg flex overflow-hidden border border-gray-200">
                    <button id="zoom-out" class="p-2 hover:bg-gray-100 text-gray-600 w-10 border-r border-gray-100" title="Zoom Out"><i class="fas fa-minus"></i></button>
                    <span id="zoom-level" class="px-3 py-2 text-xs font-mono text-gray-500 flex items-center bg-gray-50">100%</span>
                    <button id="zoom-in" class="p-2 hover:bg-gray-100 text-gray-600 w-10 border-l border-gray-100" title="Zoom In"><i class="fas fa-plus"></i></button>
                </div>
            </div>

        </div>
    </main>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 left-1/2 transform -translate-x-1/2 bg-slate-800 text-white px-6 py-3 rounded-full shadow-2xl transition-all duration-300 z-50 opacity-0 translate-y-[-20px] pointer-events-none flex items-center gap-3">
        <i class="fas fa-check-circle text-green-400"></i> <span id="toast-msg">Message</span>
    </div>

    <script>
        // --- State Management ---
        const state = {
            files: [], 
            currentFileIndex: 0,
            previewDoc: null, 
            imgBytes: null, 
            imgType: null,
            pageNum: 1,
            scale: 1.0, 
            totalPages: 0,
            name: "",
            date: new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }),
            blockEl: null,
            customPositions: {},
            batchTemplate: null
        };

        // --- DOM Elements ---
        const els = {
            sidebar: document.getElementById('sidebar'),
            toggleSidebarBtn: document.getElementById('toggle-sidebar'),
            pdfInput: document.getElementById('pdf-input'),
            imgInput: document.getElementById('img-input'),
            pdfName: document.getElementById('pdf-name'),
            fileCount: document.getElementById('file-count'),
            clearPdfsBtn: document.getElementById('clear-pdfs'),
            fileListContainer: document.getElementById('file-list-container'),
            fileList: document.getElementById('file-list'),
            imgName: document.getElementById('img-name'),
            nameInput: document.getElementById('sig-name-input'),
            dateDisplay: document.getElementById('system-date'),
            controlsOverlay: document.getElementById('controls-overlay'),
            canvas: document.getElementById('pdf-render'),
            container: document.getElementById('canvas-container'),
            blankState: document.getElementById('blank-state'),
            prevBtn: document.getElementById('prev-page'),
            nextBtn: document.getElementById('next-page'),
            prevFileBtn: document.getElementById('prev-file'),
            nextFileBtn: document.getElementById('next-file'),
            currentFileDisplay: document.getElementById('current-file-display'),
            currPageSpan: document.getElementById('curr-page'),
            totalPageSpan: document.getElementById('total-pages'),
            saveBtn: document.getElementById('save-btn'),
            downloadText: document.getElementById('download-text'),
            toast: document.getElementById('toast'),
            toastMsg: document.getElementById('toast-msg'),
            positionSelect: document.getElementById('position-select'),
            applyAllBtn: document.getElementById('apply-all-btn'),
            zoomIn: document.getElementById('zoom-in'),
            zoomOut: document.getElementById('zoom-out'),
            zoomLevel: document.getElementById('zoom-level'),
            tourBtn: document.getElementById('start-tour-btn')
        };

        const ctx = els.canvas.getContext('2d');
        els.dateDisplay.textContent = state.date;
        els.saveBtn.disabled = true;

        // Mobile Sidebar Toggle logic
        let sidebarOpen = false;
        els.toggleSidebarBtn.addEventListener('click', () => {
            sidebarOpen = !sidebarOpen;
            if(sidebarOpen) {
                els.sidebar.classList.remove('-translate-x-full', 'absolute');
                els.sidebar.classList.add('absolute', 'z-40', 'h-full');
            } else {
                els.sidebar.classList.add('-translate-x-full', 'absolute');
            }
        });

        // --- Event Listeners ---
        
        // PDF Upload
        els.pdfInput.addEventListener('change', async (e) => {
            const rawFiles = Array.from(e.target.files);
            if (rawFiles.length === 0) return;

            const newFilePromises = rawFiles.map(async (file) => {
                return { name: file.name, buffer: await file.arrayBuffer() };
            });

            const newFiles = await Promise.all(newFilePromises);
            state.files = [...state.files, ...newFiles];

            updateFileUI();

            if (state.files.length === newFiles.length) {
                // First load
                state.currentFileIndex = 0;
                await loadFileForPreview(0);
            } else {
                updateNavButtons();
            }
            
            checkReady();
            els.pdfInput.value = '';
        });

        // Clear PDFs
        els.clearPdfsBtn.addEventListener('click', () => {
            state.files = [];
            state.customPositions = {};
            state.currentFileIndex = 0;
            state.previewDoc = null;
            state.pageNum = 1;
            
            updateFileUI();
            els.controlsOverlay.classList.add('opacity-50', 'pointer-events-none');
            els.blankState.classList.remove('hidden');
            els.container.classList.add('hidden');
            els.saveBtn.disabled = true;
            
            if(state.blockEl) state.blockEl.style.display = 'none';
        });

        // Image Upload
        els.imgInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            els.imgName.textContent = file.name;
            state.imgType = file.type;

            const reader = new FileReader();
            reader.onload = (event) => {
                const img = new Image();
                img.onload = () => {
                    state.imgBytes = event.target.result;
                    renderSignatureBlock();
                    checkReady();
                    showToast("Signature Image Loaded");
                };
                img.src = event.target.result;
            };
            reader.readAsDataURL(file);
        });

        // Name Input
        els.nameInput.addEventListener('input', (e) => {
            state.name = e.target.value;
            renderSignatureBlock();
        });

        // Navigation
        els.prevBtn.addEventListener('click', () => {
            if (state.pageNum <= 1) return;
            state.pageNum--;
            renderPage();
        });

        els.nextBtn.addEventListener('click', () => {
            if (state.pageNum >= state.totalPages) return;
            state.pageNum++;
            renderPage();
        });

        els.prevFileBtn.addEventListener('click', () => {
            if (state.currentFileIndex > 0) {
                loadFileForPreview(state.currentFileIndex - 1);
            }
        });

        els.nextFileBtn.addEventListener('click', () => {
            if (state.currentFileIndex < state.files.length - 1) {
                loadFileForPreview(state.currentFileIndex + 1);
            }
        });

        // Zoom
        els.zoomIn.addEventListener('click', () => {
            if(state.scale < 2.5) {
                state.scale += 0.2;
                renderPage();
                updateZoomDisplay();
            }
        });
        els.zoomOut.addEventListener('click', () => {
            if(state.scale > 0.4) {
                state.scale -= 0.2;
                renderPage();
                updateZoomDisplay();
            }
        });
        function updateZoomDisplay() {
            els.zoomLevel.textContent = Math.round(state.scale * 100) + '%';
        }

        // Positioning
        els.positionSelect.addEventListener('change', (e) => {
            const mode = e.target.value;
            if (state.blockEl && mode !== 'manual') {
                applyPositionPreset(mode);
                saveCurrentPosition();
            }
        });

        els.applyAllBtn.addEventListener('click', () => {
            if (!state.blockEl) return;
            saveCurrentPosition();
            const currentKey = `${state.currentFileIndex}-${state.pageNum}`;
            const pos = state.customPositions[currentKey];
            state.batchTemplate = { ...pos };
            showToast("Position copied to all pages!");
        });

        els.saveBtn.addEventListener('click', generateAll);

        // --- TOUR Logic ---
        els.tourBtn.addEventListener('click', startTour);

        function startTour() {
            const driver = window.driver.js.driver;
            
            const driverObj = driver({
                showProgress: true,
                popoverClass: 'driverjs-theme',
                steps: [
                    { 
                        element: '#sidebar', 
                        popover: { 
                            title: 'Control Panel', 
                            description: 'This sidebar is your command center. You will configure everything here.' 
                        } 
                    },
                    { 
                        element: '#tour-step-1', 
                        popover: { 
                            title: '1. Upload Documents', 
                            description: 'Start by clicking here to upload your PDF files. You can upload multiple files at once.' 
                        } 
                    },
                    { 
                        element: '#tour-step-2', 
                        popover: { 
                            title: '2. Setup Signature', 
                            description: 'Upload your signature image (PNG/JPG) here. It will automatically overlay on the PDF.' 
                        } 
                    },
                    { 
                        element: '#workspace-scroll', 
                        popover: { 
                            title: '3. Preview & Edit', 
                            description: 'Your PDF will appear here. You can drag the signature block to position it manually.' 
                        } 
                    },
                    { 
                        element: '#tour-step-4', 
                        popover: { 
                            title: '4. Navigate', 
                            description: 'Use these controls to switch between files and pages.' 
                        } 
                    },
                    { 
                        element: '#tour-step-5', 
                        popover: { 
                            title: '5. Fast Positioning', 
                            description: 'Use the dropdown to quickly snap the signature to corners. Use "Apply to All" to set the position for every page in every file at once.' 
                        } 
                    },
                    { 
                        element: '#save-btn', 
                        popover: { 
                            title: '6. Download', 
                            description: 'Once you are happy, click here to download your signed PDF(s). Processing happens entirely in your browser!' 
                        } 
                    }
                ]
            });

            driverObj.drive();
        }


        // --- Logic & Helpers ---

        function updateFileUI() {
            const count = state.files.length;
            if (count > 0) {
                els.pdfName.textContent = "Add PDFs";
                els.fileCount.textContent = `${count} files`;
                els.fileListContainer.classList.remove('hidden');
                
                els.fileList.innerHTML = '';
                state.files.forEach((file, idx) => {
                    const isActive = idx === state.currentFileIndex;
                    const li = document.createElement('li');
                    li.className = `text-xs px-2 py-1.5 rounded flex items-center gap-2 truncate ${isActive ? 'bg-blue-50 text-blue-700 font-medium' : 'text-gray-600 hover:bg-gray-100 cursor-pointer'}`;
                    li.innerHTML = `<i class="fas fa-file-pdf ${isActive ? 'text-blue-500' : 'text-gray-400'}"></i> <span class="truncate">${file.name}</span>`;
                    li.onclick = () => loadFileForPreview(idx);
                    els.fileList.appendChild(li);
                });

                if (count === 1) els.downloadText.textContent = "Download Signed PDF";
                else els.downloadText.textContent = `Download ${count} Files (ZIP)`;
            } else {
                els.pdfName.textContent = "Add PDFs";
                els.fileListContainer.classList.add('hidden');
                els.downloadText.textContent = "Download Signed PDF";
            }
        }

        function updateNavButtons() {
            els.currentFileDisplay.textContent = `File ${state.currentFileIndex + 1}/${state.files.length}`;
            els.prevFileBtn.disabled = state.currentFileIndex === 0;
            els.nextFileBtn.disabled = state.currentFileIndex === state.files.length - 1;
            
            // Re-render list to show active state
            updateFileUI();
        }

        async function loadFileForPreview(index) {
            state.currentFileIndex = index;
            updateNavButtons();

            const fileData = state.files[index];
            const loadingTask = pdfjsLib.getDocument(new Uint8Array(fileData.buffer.slice(0)));
            state.previewDoc = await loadingTask.promise;
            state.totalPages = state.previewDoc.numPages;
            state.pageNum = 1;
            
            els.totalPageSpan.textContent = state.totalPages;
            
            // UI Toggle
            els.blankState.classList.add('hidden');
            els.container.classList.remove('hidden');
            els.controlsOverlay.classList.remove('opacity-50', 'pointer-events-none');
            
            await renderPage();
        }

        function checkReady() {
            if (state.files.length > 0 && state.imgBytes) {
                els.nameInput.disabled = false;
                els.saveBtn.disabled = false;
            }
        }

        async function renderPage() {
            if (!state.previewDoc) return;
            
            els.currPageSpan.textContent = state.pageNum;
            els.prevBtn.disabled = state.pageNum <= 1;
            els.nextBtn.disabled = state.pageNum >= state.totalPages;

            const page = await state.previewDoc.getPage(state.pageNum);
            const viewport = page.getViewport({ scale: state.scale });

            els.canvas.height = viewport.height;
            els.canvas.width = viewport.width;
            els.container.style.width = `${viewport.width}px`;
            els.container.style.height = `${viewport.height}px`;

            await page.render({ canvasContext: ctx, viewport: viewport }).promise;

            if (state.blockEl) {
                state.blockEl.style.display = 'flex';
                placeBlockOnPage();
            }
        }

        function renderSignatureBlock() {
            if (!state.imgBytes) return;

            let block = document.getElementById('sig-block');
            
            if (!block) {
                block = document.createElement('div');
                block.id = 'sig-block';
                block.className = 'signature-block';
                
                const img = document.createElement('img');
                img.className = 'sig-image';
                block.appendChild(img);
                
                const nameP = document.createElement('p');
                nameP.className = 'sig-text sig-name';
                block.appendChild(nameP);

                const dateP = document.createElement('p');
                dateP.className = 'sig-text sig-date';
                block.appendChild(dateP);

                const handle = document.createElement('div');
                handle.className = 'resize-handle';
                block.appendChild(handle);

                els.container.appendChild(block);
                state.blockEl = block;
                
                initDragAndResize(block, handle);
            }

            const imgEl = block.querySelector('img');
            imgEl.src = state.imgBytes;
            
            const nameEl = block.querySelector('.sig-name');
            nameEl.textContent = state.name || "Signatory Name";
            nameEl.style.opacity = state.name ? "1" : "0.5";

            const dateEl = block.querySelector('.sig-date');
            dateEl.textContent = state.date;

            if (!block.style.width) block.style.width = '200px';

            setTimeout(placeBlockOnPage, 50);
        }

        // --- Positioning Logic ---

        function placeBlockOnPage() {
            if (!state.blockEl) return;
            const key = `${state.currentFileIndex}-${state.pageNum}`;
            
            // 1. Page Specific
            if (state.customPositions[key]) {
                applyPositionFromPct(state.customPositions[key]);
                els.positionSelect.value = "manual";
            } 
            // 2. Batch Template
            else if (state.batchTemplate) {
                applyPositionFromPct(state.batchTemplate);
                els.positionSelect.value = "manual";
            }
            // 3. Default
            else {
                applyPositionPreset("bottom-right");
                els.positionSelect.value = "bottom-right";
            }
        }

        function applyPositionPreset(mode) {
            const containerW = els.container.offsetWidth;
            const containerH = els.container.offsetHeight;
            const blockW = state.blockEl.offsetWidth;
            const blockH = state.blockEl.offsetHeight;
            const padding = 30; 

            let left = 0;
            let top = 0;

            switch (mode) {
                case 'bottom-right':
                    left = containerW - blockW - padding;
                    top = containerH - blockH - padding;
                    break;
                case 'bottom-left':
                    left = padding;
                    top = containerH - blockH - padding;
                    break;
                case 'bottom-center':
                    left = (containerW - blockW) / 2;
                    top = containerH - blockH - padding;
                    break;
                case 'top-right':
                    left = containerW - blockW - padding;
                    top = padding;
                    break;
            }
            state.blockEl.style.left = `${Math.max(0, left)}px`;
            state.blockEl.style.top = `${Math.max(0, top)}px`;
        }

        function applyPositionFromPct(pos) {
            const containerW = els.container.offsetWidth;
            const containerH = els.container.offsetHeight;
            
            const left = pos.leftPct * containerW;
            const top = pos.topPct * containerH;
            
            state.blockEl.style.left = `${left}px`;
            state.blockEl.style.top = `${top}px`;
            
            if (pos.widthPct) {
                state.blockEl.style.width = `${pos.widthPct * containerW}px`;
            }
        }

        function saveCurrentPosition() {
            const containerW = els.container.offsetWidth;
            const containerH = els.container.offsetHeight;
            const block = state.blockEl;
            
            const left = parseInt(block.style.left || 0);
            const top = parseInt(block.style.top || 0);
            const width = block.offsetWidth;

            const pos = {
                leftPct: left / containerW,
                topPct: top / containerH,
                widthPct: width / containerW
            };

            const key = `${state.currentFileIndex}-${state.pageNum}`;
            state.customPositions[key] = pos;
        }

        function initDragAndResize(el, handle) {
            let isDragging = false;
            let isResizing = false;
            let startX, startY, startLeft, startTop, startW;

            el.addEventListener('mousedown', (e) => {
                if (e.target === handle) return;
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(el.style.left || 0);
                startTop = parseInt(el.style.top || 0);
                
                els.positionSelect.value = 'manual';
                el.classList.add('active');
                e.preventDefault();
            });

            handle.addEventListener('mousedown', (e) => {
                isResizing = true;
                startX = e.clientX;
                startW = el.offsetWidth;
                e.stopPropagation();
                e.preventDefault();
            });

            window.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    const dx = e.clientX - startX;
                    const dy = e.clientY - startY;
                    let newLeft = startLeft + dx;
                    let newTop = startTop + dy;
                    
                    if (newLeft < 0) newLeft = 0;
                    if (newTop < 0) newTop = 0;
                    if (newLeft + el.offsetWidth > els.container.offsetWidth) newLeft = els.container.offsetWidth - el.offsetWidth;
                    if (newTop + el.offsetHeight > els.container.offsetHeight) newTop = els.container.offsetHeight - el.offsetHeight;

                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                } else if (isResizing) {
                    const dx = e.clientX - startX;
                    const newW = Math.max(100, startW + dx);
                    el.style.width = `${newW}px`;
                }
            });

            window.addEventListener('mouseup', () => {
                if (isDragging || isResizing) {
                    saveCurrentPosition();
                    el.classList.remove('active');
                }
                isDragging = false;
                isResizing = false;
            });
        }

        // --- Generation ---

        async function generateAll() {
            if (state.files.length === 0 || !state.blockEl) return;

            const btnOriginalText = els.downloadText.textContent;
            els.downloadText.innerHTML = '<div class="loading-spinner border-white border-t-transparent w-4 h-4 inline-block mr-2"></div> Processing...';
            els.saveBtn.disabled = true;

            try {
                const zip = new JSZip();
                const processedFiles = [];

                for (let i = 0; i < state.files.length; i++) {
                    const fileData = state.files[i];
                    const signedBytes = await processSinglePDF(fileData.buffer, i);
                    processedFiles.push({ name: fileData.name, data: signedBytes });
                }

                if (processedFiles.length === 1) {
                    download(processedFiles[0].data, `Signed_${processedFiles[0].name}`, "application/pdf");
                    showToast("PDF Saved successfully!");
                } else {
                    processedFiles.forEach(f => {
                         zip.file(`Signed_${f.name}`, f.data);
                    });
                    const zipContent = await zip.generateAsync({type: "blob"});
                    download(zipContent, "Signed_Documents.zip", "application/zip");
                    showToast("ZIP Archive Saved!");
                }

            } catch (err) {
                console.error(err);
                showToast("Error: " + err.message);
            } finally {
                els.downloadText.textContent = btnOriginalText;
                els.saveBtn.disabled = false;
            }
        }

        async function processSinglePDF(buffer, fileIndex) {
            const { PDFDocument, StandardFonts, rgb } = PDFLib;
            const pdfDoc = await PDFDocument.load(buffer.slice(0));
            
            const helveticaFont = await pdfDoc.embedFont(StandardFonts.Helvetica);
            const helveticaBold = await pdfDoc.embedFont(StandardFonts.HelveticaBold);

            const imgRes = await fetch(state.imgBytes);
            const imgBuf = await imgRes.arrayBuffer();
            let embeddedImage;
            if (state.imgType === 'image/jpeg') embeddedImage = await pdfDoc.embedJpg(imgBuf);
            else embeddedImage = await pdfDoc.embedPng(imgBuf);

            const blockW_px = state.blockEl.offsetWidth;
            const blockH_px = state.blockEl.offsetHeight;
            const s = state.scale;

            const imgEl = state.blockEl.querySelector('img');
            const domImgW = imgEl.offsetWidth;
            const domImgH = imgEl.offsetHeight;
            
            const pages = pdfDoc.getPages();
            
            for (let i = 0; i < pages.length; i++) {
                const pageNum = i + 1;
                const page = pages[i];
                const { width: pageWidth, height: pageHeight } = page.getSize();
                
                let pdfBlockX, pdfBlockYTop;
                let usedBlockW = blockW_px;

                const key = `${fileIndex}-${pageNum}`;
                let pos = null;
                if (state.customPositions[key]) {
                    pos = state.customPositions[key];
                } else if (state.batchTemplate) {
                    pos = state.batchTemplate;
                }

                if (pos) {
                    pdfBlockX = pos.leftPct * pageWidth;
                    const pdfTopY = pageHeight - (pos.topPct * pageHeight);
                    pdfBlockYTop = pdfTopY;
                    if (pos.widthPct) usedBlockW = pos.widthPct * pageWidth * s;
                } else {
                    const padding = 30 / s;
                    const blockW_PDF = blockW_px / s;
                    const blockH_PDF = blockH_px / s;
                    pdfBlockX = pageWidth - blockW_PDF - padding;
                    pdfBlockYTop = padding + blockH_PDF;
                }

                const pdfBlockW = (pos && pos.widthPct) ? (pos.widthPct * pageWidth) : (usedBlockW / s);
                const ratio = domImgH / domImgW;
                const drawImgW = pdfBlockW; 
                const drawImgH = drawImgW * ratio;
                const imgY = pdfBlockYTop - drawImgH;

                // Draw Text
                const nameText = state.name || "";
                let pdfNameY = 0;
                
                if (nameText) {
                    const fontSize = 12;
                    const textWidth = helveticaBold.widthOfTextAtSize(nameText, fontSize);
                    const textXOffset = (pdfBlockW - textWidth) / 2;
                    const gap = 0; 
                    
                    pdfNameY = imgY - gap - fontSize;

                    page.drawText(nameText, {
                        x: pdfBlockX + textXOffset,
                        y: pdfNameY,
                        size: fontSize,
                        font: helveticaBold,
                        color: rgb(0, 0, 0),
                    });

                    page.drawLine({
                        start: { x: pdfBlockX + textXOffset, y: pdfNameY - 2 },
                        end: { x: pdfBlockX + textXOffset + textWidth, y: pdfNameY - 2 },
                        thickness: 1,
                        color: rgb(0, 0, 0),
                    });

                    const dateText = state.date;
                    const dateFontSize = 10;
                    const dateWidth = helveticaFont.widthOfTextAtSize(dateText, dateFontSize);
                    const dateXOffset = (pdfBlockW - dateWidth) / 2;
                    const pdfDateY = pdfNameY - 14; 

                    page.drawText(dateText, {
                        x: pdfBlockX + dateXOffset,
                        y: pdfDateY,
                        size: dateFontSize,
                        font: helveticaFont,
                        color: rgb(0.2, 0.2, 0.2),
                    });
                }

                // Draw Image
                page.drawImage(embeddedImage, {
                    x: pdfBlockX,
                    y: imgY,
                    width: drawImgW,
                    height: drawImgH,
                });
            }

            return await pdfDoc.save();
        }

        function download(data, filename, type) {
            const blob = (data instanceof Blob) ? data : new Blob([data], { type: type });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
        }

        function showToast(msg) {
            els.toastMsg.textContent = msg;
            els.toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => els.toast.classList.add('opacity-0', 'translate-y-[-20px]'), 3000);
        }
    </script>
</body>
</html>
